<div class="form-container">
  <div class="form-card">
    <h1 class="form-titulo">{{ isEdicao ? '‚úèÔ∏è Editar' : '‚ûï Nova' }} Lista de Compras</h1>

    <!-- Informa√ß√µes da Lista -->
    <div class="form-section">
      <h2 class="section-titulo">Informa√ß√µes Gerais</h2>
      
      <div class="form-group">
        <label for="loja">Loja / Fornecedor *</label>
        <input 
          type="text" 
          id="loja" 
          [(ngModel)]="lista.lojaFornecedor"
          placeholder="Ex: Supermercado ABC"
          class="form-input">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="dataCriacao">Data de Cria√ß√£o</label>
          <input 
            type="date" 
            id="dataCriacao" 
            [(ngModel)]="dataCriacaoFormatada"
            class="form-input"
            disabled>
        </div>

        <div class="form-group">
          <label for="dataCompra">Data da Compra *</label>
          <input 
            type="date" 
            id="dataCompra" 
            [(ngModel)]="dataCompraFormatada"
            class="form-input">
        </div>
      </div>

      <!-- Supermercados -->
      <div class="form-group">
        <label>Supermercados</label>
        <div class="supermercados-input">
          <input 
            type="text" 
            [(ngModel)]="novoSupermercado"
            placeholder="Ex: Atacad√£o"
            class="form-input"
            (keyup.enter)="adicionarSupermercado()">
          <button type="button" class="btn-add-super" (click)="adicionarSupermercado()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
        <div class="supermercados-lista" *ngIf="supermercadosDisponiveis.length > 0">
          @for (super of supermercadosDisponiveis; track super) {
            <span class="super-tag">
              {{ super }}
              <button type="button" class="btn-remove-super" (click)="removerSupermercado(super)">√ó</button>
            </span>
          }
        </div>
      </div>
    </div>

    <!-- Lista de Itens -->
    <div class="form-section">
      <div class="section-header">
        <h2 class="section-titulo">Itens da Lista</h2>
        <button 
          class="btn-adicionar-item" 
          (click)="mostrarFormItem = !mostrarFormItem"
          *ngIf="!mostrarFormItem">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Adicionar Item
        </button>
      </div>

      <!-- Formul√°rio de Item -->
      <div class="item-form" *ngIf="mostrarFormItem">
        <h3 class="item-form-titulo">{{ itemEditandoIndex !== null ? 'Editar' : 'Novo' }} Item</h3>
        
        <div class="form-group">
          <label for="nomeProduto">Nome do Produto / Item *</label>
          <input 
            type="text" 
            id="nomeProduto" 
            [(ngModel)]="novoItem.nomeProduto"
            placeholder="Ex: Farinha de Trigo"
            class="form-input">
        </div>

        <div class="form-group">
          <label for="supermercado">Supermercado *</label>
          <select 
            id="supermercado" 
            [(ngModel)]="novoItem.supermercado"
            class="form-input">
            <option value="">Selecione um supermercado</option>
            @for (super of supermercadosDisponiveis; track super) {
              <option [value]="super">{{ super }}</option>
            }
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="quantidade">Quantidade *</label>
            <input 
              type="number" 
              id="quantidade" 
              [(ngModel)]="novoItem.quantidade"
              (ngModelChange)="calcularPrecoItem()"
              min="1"
              class="form-input">
          </div>

          <div class="form-group">
            <label for="precoUnitario">Pre√ßo Unit√°rio (R$) *</label>
            <input 
              type="number" 
              id="precoUnitario" 
              [(ngModel)]="novoItem.precoUnitario"
              (ngModelChange)="calcularPrecoItem()"
              min="0"
              step="0.01"
              class="form-input">
          </div>
        </div>

        <!-- Pre√ßo Atacado -->
        <div class="atacado-section">
          <h4 class="atacado-titulo">üí∞ Pre√ßo Atacado (Opcional)</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="quantidadeAtacado">Quantidade M√≠nima</label>
              <input 
                type="number" 
                id="quantidadeAtacado" 
                [(ngModel)]="novoItem.quantidadeAtacado"
                (ngModelChange)="calcularPrecoItem()"
                min="1"
                placeholder="Ex: 10"
                class="form-input">
            </div>

            <div class="form-group">
              <label for="precoAtacado">Pre√ßo Atacado (R$)</label>
              <input 
                type="number" 
                id="precoAtacado" 
                [(ngModel)]="novoItem.precoAtacado"
                (ngModelChange)="calcularPrecoItem()"
                min="0"
                step="0.01"
                placeholder="Ex: 8.50"
                class="form-input">
            </div>
          </div>
        </div>

        <div class="preco-total-preview">
          <span class="preco-label">Pre√ßo Total do Item:</span>
          <span class="preco-value">{{ formatarValor(novoItem.precoTotal) }}</span>
        </div>

        <div class="item-form-acoes">
          <button class="btn-cancelar" (click)="cancelarItem()">Cancelar</button>
          <button class="btn-salvar-item" (click)="salvarItem()">
            {{ itemEditandoIndex !== null ? 'Atualizar' : 'Adicionar' }}
          </button>
        </div>
      </div>

      <!-- Lista de Itens Adicionados -->
      <div class="itens-lista" *ngIf="lista.itens.length > 0">
        @for (item of lista.itens; track item.id; let i = $index) {
          <div class="item-card" [class.comprado]="item.comprado">
            <div class="checkbox-wrapper">
              <input 
                type="checkbox" 
                [id]="'item-' + i"
                [checked]="item.comprado"
                (change)="toggleItemComprado(i)"
                class="item-checkbox">
              <label [for]="'item-' + i" class="checkbox-label"></label>
            </div>
            <div class="item-info">
              <h4 class="item-nome" [class.riscado]="item.comprado">{{ item.nomeProduto }}</h4>
              <div class="item-detalhes">
                <span class="item-detalhe">üè™ {{ item.supermercado }}</span>
                <span class="item-detalhe">Qtd: {{ item.quantidade }}</span>
                <span class="item-detalhe">Unit: {{ formatarValor(item.precoUnitario) }}</span>
                @if (item.quantidadeAtacado && item.precoAtacado && item.quantidade >= item.quantidadeAtacado) {
                  <span class="badge-atacado">Atacado</span>
                }
              </div>
            </div>
            <div class="item-acoes">
              <span class="item-total">{{ formatarValor(item.precoTotal) }}</span>
              <button class="btn-icon-small" (click)="editarItem(i)" title="Editar">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="btn-icon-small btn-delete" (click)="removerItem(i)" title="Remover">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
        }
      </div>

      <div class="empty-itens" *ngIf="lista.itens.length === 0 && !mostrarFormItem">
        <p>Nenhum item adicionado. Clique em "Adicionar Item" para come√ßar.</p>
      </div>
    </div>

    <!-- Valor Total -->
    <div class="total-section">
      <span class="total-label">Valor Total da Compra:</span>
      <span class="total-value">{{ formatarValor(lista.valorTotal) }}</span>
    </div>

    <!-- A√ß√µes do Formul√°rio -->
    <div class="form-acoes">
      <button class="btn-cancelar-form" (click)="cancelar()">Cancelar</button>
      <button class="btn-salvar-form" (click)="salvarLista()">
        {{ isEdicao ? 'Atualizar' : 'Salvar' }} Lista
      </button>
      <button 
        class="btn-finalizar-form" 
        (click)="finalizarCompra()"
        *ngIf="podeFinalizarCompra">
        ‚úÖ Finalizar Compra
      </button>
    </div>
  </div>
</div>
